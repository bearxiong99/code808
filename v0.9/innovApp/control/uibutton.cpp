#include "uibutton.h"
//#include "guiconfig.h" 
#include <QPixmapCache>
/**************************************************************************************************
** ÂáΩÊï∞Âê? UIButton
**
** Âä? ËÉ? ÊûÑÈÄ†ÂáΩÊï?**
** Âè? Êï? QWidget *parent                  : Áà∂Á™óÂè?**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
UIButton::UIButton(QWidget *parent)
:QWidget(parent)
{
	m_bcheck = false;
	m_bfocus = false;
	//m_imgPath = GetHMICfg()->cResHmiFolder;

#if defined(QT_PLUGIN)
    m_imgPath = "../resource/";
#else
    m_imgPath = ":/";
#endif

	//setMouseTracking(true);//ËÆæÁΩÆÈº†Ê†áË∑üË∏™‰∫ã‰ª∂
	m_buttonState = BUTTON_NORMAL;
	m_timer = new QTimer(this);
	connect(m_timer, SIGNAL(timeout()), this, SLOT(LongPress()));
	update();
}

void UIButton::setvisible(const bool bvisibale)
{
	m_bvisibale = bvisibale;
	setVisible(m_bvisibale);
	update();
}

bool UIButton::isvisibale() const
{
	return m_bvisibale;
}

UIButton::~UIButton()
{

}

/**************************************************************************************************
** ÂáΩÊï∞Âê? mousePressEvent
**
** Âä? ËÉ? Èº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂
**
** Âè? Êï? QMouseEvent *                    : Èº†Ê†á‰∫ã‰ª∂
**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
void UIButton::mousePressEvent(QMouseEvent *)
{
	if (BUTTON_DISABLE != m_buttonState)
	{
		m_buttonState = BUTTON_PRESS;
		m_timer->start(2000);
		repaint();
	}
}

/**************************************************************************************************
** ÂáΩÊï∞Âê? mouseReleaseEvent
**
** Âä? ËÉ? Èº†Ê†áÈáäÊîæ‰∫ã‰ª∂
**
** Âè? Êï? QMouseEvent *                    : Èº†Ê†á‰∫ã‰ª∂
**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
void UIButton::mouseReleaseEvent(QMouseEvent *)
{
	if (BUTTON_DISABLE != m_buttonState && BUTTON_NORMAL != m_buttonState)
	{
		m_buttonState = BUTTON_RELEASE;
		if (m_timer->isActive())
			m_timer->stop();
		if (isEnabled())
		{
			emit(clicked());
		}
		update();
	}
}

/**************************************************************************************************
** ÂáΩÊï∞Âê? mouseMoveEvent
**
** Âä? ËÉ? Èº†Ê†áÁßªÂä®‰∫ã‰ª∂
**
** Âè? Êï? QMouseEvent *                    : Èº†Ê†á‰∫ã‰ª∂
**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
void UIButton::mouseMoveEvent(QMouseEvent *e)
{
	if (BUTTON_DISABLE != m_buttonState)
	{
		QRect rc;
		QPoint p;
		QMouseEvent *mouseEvent=NULL;

		if (QMouseEvent::MouseMove == e->type())
		{
			mouseEvent = (QMouseEvent *)e;

			if (mouseEvent->buttons() & Qt::LeftButton)
			{
				//p = e->pos();
				//rc = this->rect();
				//Èº†Ê†áÁßªÂä®Âú®Âå∫ÂüüÂÜÖ

				/*//ÂºÇÂΩ¢Êéß‰ª∂ÂìçÂ∫îÁöÑÂÆûÁé?				QPixmap m_bkimg;
				QBitmap bm(m_bkimg.mask());
				QRegion region(bm);
				region.contains(e->pos())*/
				if(this->rect().contains(e->pos()))
					// 				if (((rc.x() <= p.x()) && ((rc.x() + rc.width()) >= p.x()))&&
					// 					((rc.y() <= p.y()) && (rc.y() + rc.height()) >= p.y()))
				{
					m_buttonState = BUTTON_PRESSMOVE;
				}
				else
				{
					if (m_timer->isActive())
						m_timer->stop();
					m_buttonState = BUTTON_NORMAL;
				}

				update();
			}
		}
		//emit move(p);
	}
}

/**************************************************************************************************
** ÂáΩÊï∞Âê? enterEvent
**
** Âä? ËÉ? ÂΩìÈº†Ê†áÁßªÂÖ•Âà∞ÊåâÈíÆÂÜÖÊó∂ÔºåÊõ¥Êñ∞ÊåâÈíÆÂõæÊ†?**
** Âè? Êï? QMouseEvent *                    : Èº†Ê†á‰∫ã‰ª∂
**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
void UIButton::enterEvent(QEvent *)
{
	if (BUTTON_DISABLE != m_buttonState)
	{
		m_buttonState = BUTTON_MOVE;

		update();
	}
}

/**************************************************************************************************
** ÂáΩÊï∞Âê? leaveEvent
**
** Âä? ËÉ? ÂΩìÈº†Ê†áÁßªÂá∫Âà∞ÊåâÈíÆ‰ª•Â§ñÊó∂ÔºåÊõ¥Êñ∞ÊåâÈíÆÂõæÊ†á
**
** Âè? Êï? QMouseEvent *                    : Èº†Ê†á‰∫ã‰ª∂
**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
void UIButton::leaveEvent(QEvent *)
{
	if (BUTTON_DISABLE != m_buttonState)
	{
		m_buttonState = BUTTON_NORMAL;

		update();
	}
}

void UIButton::uncheck()
{
	setChecked(false);
}

/**************************************************************************************************
** ÂáΩÊï∞Âê? setNormalIcon
**
** Âä? ËÉ? ËÆæÁΩÆÊåâÈíÆÊ≠£Â∏∏Áä∂ÊÄÅ‰∏ãÁöÑÂõæÊ†?**
** Âè? Êï? const QString &normalIconName    : ÂõæÊ†áË∑ØÂæÑ
**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
void UIButton::setNormalIcon(const QString &imgName)
{
	if (!imgName.isEmpty())
	{
		m_sIconnormal = imgName;
		if (!QPixmapCache::find(m_imgPath + m_sIconnormal, m_normalIconimg)) {
			m_normalIconimg.load(m_imgPath + m_sIconnormal);
			QPixmapCache::insert(m_imgPath + m_sIconnormal, m_normalIconimg);
		}
		//m_normalIconimg.load(m_imgPath + m_sIconnormal);
	}
	update();
}

QString UIButton::NormalIcon() const
{
	return m_sIconnormal;
}

void UIButton::setPressIcon(const QString &imgName)
{
	if (!imgName.isEmpty())
	{
		m_sIconpress = imgName;
		if (!QPixmapCache::find(m_imgPath + m_sIconpress, m_pressIconimg)) {
			m_pressIconimg.load(m_imgPath + m_sIconpress);
			QPixmapCache::insert(m_imgPath + m_sIconpress, m_pressIconimg);
		}
		//m_pressIconimg.load(m_imgPath + m_sIconpress);

	}
	update();
}

QString UIButton::PressIcon() const
{
	return m_sIconpress;
}
/**************************************************************************************************
** ÂáΩÊï∞Âê? setPressIcon
**
** Âä? ËÉ? ËÆæÁΩÆÊåâÈíÆË¢´Êåâ‰∏ãÁä∂ÊÄÅ‰∏ãÁöÑÂõæÊ†?**
** Âè? Êï? const QString &pressIconName     : ÂõæÊ†áË∑ØÂæÑ
**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
void UIButton::setDisableIcon(const QString &imgName)
{
	if (!imgName.isEmpty())
	{
		m_sIcondisable = imgName;
		if (!QPixmapCache::find(m_imgPath + m_sIcondisable, m_disableIconimg)) {
			m_disableIconimg.load(m_imgPath + m_sIcondisable);
			QPixmapCache::insert(m_imgPath + m_sIcondisable, m_disableIconimg);
		}
		//m_disableIconimg.load(m_imgPath + m_sIcondisable);

	}
	update();

}

QString UIButton::DisableIcon() const
{
	return m_sIcondisable;
}


/**************************************************************************************************
** ÂáΩÊï∞Âê? setMoveIcon
**
** Âä? ËÉ? ËÆæÁΩÆÈº†Ê†áÂú®ÊåâÈíÆ‰∏äÁßªÂä®Áä∂ÊÄÅ‰∏ãÁöÑÂõæÊ†?**
** Âè? Êï? const QString &moveIconName      : ÂõæÊ†áË∑ØÂæÑ
**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
void UIButton::setNormalBk(const QString &imgName)
{
	if (!imgName.isEmpty())
	{
		m_sBgnormal = imgName;
		if (!QPixmapCache::find(m_imgPath + m_sBgnormal, m_normalBkimg)) {
			m_normalBkimg.load(m_imgPath + m_sBgnormal);
			QPixmapCache::insert(m_imgPath + m_sBgnormal, m_normalBkimg);
		}
		//m_normalBkimg.load(m_imgPath + m_sBgnormal);
	}
	update();

}

QString UIButton::NormalBk() const
{
	return m_sBgnormal;
}

void UIButton::setPressBk(const QString &imgName)
{
	if (!imgName.isEmpty())
	{
		m_sBgpress = imgName;
		if (!QPixmapCache::find(m_imgPath + m_sBgpress, m_pressBkimg)) {
			m_pressBkimg.load(m_imgPath + m_sBgpress);
			QPixmapCache::insert(m_imgPath + m_sBgpress, m_pressBkimg);
		}
		//m_pressBkimg.load(m_imgPath + m_sBgpress);
	}
	update();

}

QString UIButton::PressBk() const
{
	return m_sBgpress;
}

void UIButton::setDisableBk(const QString &imgName)
{
	if (!imgName.isEmpty())
	{
		m_sBgdisable = imgName;
		if (!QPixmapCache::find(m_imgPath + m_sBgdisable, m_disableBkimg)) {
			m_disableBkimg.load(m_imgPath + m_sBgdisable);
			QPixmapCache::insert(m_imgPath + m_sBgdisable, m_disableBkimg);
		}
		//m_disableBkimg.load(m_imgPath + m_sBgdisable);
	}
	update();

}

QString UIButton::DisableBk() const
{
	return m_sBgdisable;
}

void UIButton::setCheckedBk(const QString &imgName)
{
	if (!imgName.isEmpty())
	{
		m_sBgcheck = imgName;
		if (!QPixmapCache::find(m_imgPath + m_sBgcheck, m_checkBkimg)) {
			m_checkBkimg.load(m_imgPath + m_sBgcheck);
			QPixmapCache::insert(m_imgPath + m_sBgcheck, m_checkBkimg);
		}
		//m_checkBkimg.load(m_imgPath + m_sBgcheck);
	}
	update();

}

QString UIButton::CheckedBk() const
{
	return m_sBgcheck;
}

void UIButton::setIconRect(const QRect &rect)
{
	m_iconRect = rect;
	update();
}

QRect UIButton::IconRect() const
{
	return m_iconRect;
}

void UIButton::setTextRect(const QRect &rect)
{
	m_textRect = rect;
	update();
}

QRect UIButton::textRect() const
{
	return m_textRect;
}


void UIButton::setColor(const QColor &color)
{
	m_color = color;
	update();
}

QColor UIButton::color() const
{
	return m_color;
}

void UIButton::setDisableColor(const QColor &color)
{
	m_discolor = color;
	update();
}

QColor UIButton::disablecolor() const
{
	return m_discolor;
}

/**************************************************************************************************
** ÂáΩÊï∞Âê? enabled
**
** Âä? ËÉ? ËÆæÁΩÆÊåâÈíÆÂêÑÁßçÁä∂ÊÄ?‰ΩøËÉΩ/Á¶ÅÊ≠¢)
**
** Âè? Êï? bool flg                         : false/true
**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
void UIButton::enabled(bool flg)
{

	if (false == flg)
	{
		m_buttonState = BUTTON_DISABLE;
	}
	else
	{
		m_buttonState = BUTTON_NORMAL;
	}

	this->setEnabled(flg);
}

void UIButton::setChecked(bool flg)
{
	m_bcheck = flg;
	update();
}

bool UIButton::isChecked()
{
	return m_bcheck;
}

void UIButton::setFocused(bool flg)
{
	m_bfocus = flg;
	update();
}

bool UIButton::isFocused()
{
	return m_bfocus;
}

/**************************************************************************************************
** ÂáΩÊï∞Âê? setUIButtonSize
**
** Âä? ËÉ? ËÆæÁΩÆÊåâÈíÆ‰ΩçÁΩÆ
**
** Âè? Êï? const QRect &rc                  : Áü©ÂΩ¢Âå∫Âüü
**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
void UIButton::setUIButtonSize(const QRect &rc)
{
	this->setGeometry(rc);
}

/**************************************************************************************************
** ÂáΩÊï∞Âê? setUIButtonSize
**
** Âä? ËÉ? ËÆæÁΩÆÊåâÈíÆ‰ΩçÁΩÆ
**
** Âè? Êï? int x                            : Â∑¶‰∏äx
**         int y                            : Â∑¶‰∏äy
**         int width                        : ÂÆ?**         int height                       : È´?**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
void UIButton::setUIButtonSize(int x, int y, int width, int height)
{
	this->setGeometry(x, y, width, height);
}

void UIButton::setResPath(const QString& path)
{
	m_imgPath = path;
}

QString UIButton::ResPath() const
{
	return m_imgPath;
}

void UIButton::setText(QString name)
{
	m_text = name;
	update();
}

QString UIButton::Text() const
{
	return m_text;
}

void UIButton::LongPress()
{
	if (m_timer->isActive())
		m_timer->stop();

	emit(LongPressed());
}

/**************************************************************************************************
** ÂáΩÊï∞Âê? paintEvent
**
** Âä? ËÉ? ÈáçÁªò
**
** Âè? Êï? QPaintEvent *                    : ÈáçÁªò‰∫ã‰ª∂
**
** Ëø? Âõ? Êó?**
**************************************************************************************************/
void UIButton::paintEvent(QPaintEvent *)
{
	if (!m_bvisibale)
	{
		return;
	}
	QRect rc;
	rc = this->rect();
	QPainter painter(this);

	painter.setRenderHint(QPainter::Antialiasing);

	if (BUTTON_PRESS == m_buttonState || BUTTON_PRESSMOVE == m_buttonState)//Êåâ‰∏ãÁä∂ÊÄ?	
	{
		if (m_bcheck && !m_checkBkimg.isNull())
		{
			painter.drawPixmap(0, 0, m_checkBkimg);
		}
		else if (m_bfocus && !m_pressBkimg.isNull())
		{
			painter.drawPixmap(0, 0, m_pressBkimg);
		}
		else
		{
			painter.drawPixmap(0, 0, m_pressBkimg);
		}
		if (m_bcheck)
		{
			if(m_iconRect.isValid())
				painter.drawPixmap(m_iconRect, m_pressIconimg);
			else
				painter.drawPixmap(0,0, m_pressIconimg);
		}
		else
		{
			if(m_iconRect.isValid())
				painter.drawPixmap(m_iconRect, m_normalIconimg);
			else
				painter.drawPixmap(0,0, m_normalIconimg);
		}
	}
	else if ((BUTTON_NORMAL == m_buttonState) || (BUTTON_RELEASE == m_buttonState))//ÈáäÊîæÊàñÊ≠£Â∏∏Áä∂ÊÄ?	
	{
		if (m_bcheck && !m_checkBkimg.isNull())
		{
			painter.drawPixmap(0, 0, m_checkBkimg);
		}
		else if (m_bfocus && !m_pressBkimg.isNull())
		{
			painter.drawPixmap(0, 0, m_pressBkimg);
		}
		else
		{
			painter.drawPixmap(0, 0, m_normalBkimg);
		}

		if (m_bcheck)
		{
			if(m_iconRect.isValid())
				painter.drawPixmap(m_iconRect, m_pressIconimg);
			else
				painter.drawPixmap(0,0, m_pressIconimg);
		}
		else
		{
			if(m_iconRect.isValid())
				painter.drawPixmap(m_iconRect, m_normalIconimg);
			else
				painter.drawPixmap(0,0, m_normalIconimg);
		}
	}
	else if (BUTTON_MOVE == m_buttonState)//ÁßªÂä®Áä∂ÊÄ?	
	{
		if (m_bcheck && !m_checkBkimg.isNull())
		{
			painter.drawPixmap(0, 0, m_checkBkimg);
		}
		else if (m_bfocus && !m_pressBkimg.isNull())
		{
			painter.drawPixmap(0, 0, m_pressBkimg);
		}
		else
		{
			painter.drawPixmap(0, 0, m_normalBkimg);
		}
		if (m_bcheck)
		{
			if(m_iconRect.isValid())
				painter.drawPixmap(m_iconRect, m_pressIconimg);
			else
				painter.drawPixmap(0,0, m_pressIconimg);
		}
		else
		{
			if(m_iconRect.isValid())
				painter.drawPixmap(m_iconRect, m_normalIconimg);
			else
				painter.drawPixmap(0,0, m_normalIconimg);
		}
	}
	else if (BUTTON_DISABLE == m_buttonState)//Á¶ÅÊ≠¢Áä∂ÊÄ?	
	{
		painter.drawPixmap(0, 0, m_disableBkimg);
		if(m_iconRect.isValid())
			painter.drawPixmap(m_iconRect, m_disableIconimg);
		else
			painter.drawPixmap(0,0, m_disableIconimg);
	}
	if (!m_text.isEmpty())
	{
		if (this->isEnabled())
		{
			painter.setPen(QColor(m_color));
		}
		else
		{
			painter.setPen(QColor(m_discolor));
		}
		QFontMetrics fm(font());
		QString text2 = fm.elidedText(m_text, Qt::ElideRight, m_textRect.width());
		painter.drawText(m_textRect,m_textalign,text2);
	}

}

